# Code Review Session

- **任务**: 写一个解析 URL 查询参数的函数
- **时间**: 2026/2/3 11:09:24
- **状态**: 通过
- **迭代次数**: 1

---

## Round 1

### Writer 输出

```typescript
interface QueryParams {
  [key: string]: string | string[];
}

/**
 * 解析 URL 查询参数
 * @param urlOrQueryString - URL 字符串或查询参数字符串
 * @returns 解析后的查询参数对象
 */
function parseQueryParams(urlOrQueryString?: string): QueryParams {
  if (!urlOrQueryString || typeof urlOrQueryString !== 'string') {
    return {};
  }

  let queryString = urlOrQueryString;

  // 如果是完整的 URL，提取查询字符串部分
  const urlMatch = urlOrQueryString.match(/^(?:https?:\/\/[^?#]+)?\?([^#]*)/);
  if (urlMatch) {
    queryString = urlMatch[1];
  } else if (!urlOrQueryString.includes('=') && !urlOrQueryString.includes('&')) {
    // 如果看起来不像查询字符串，返回空对象
    return {};
  }

  // 处理空查询字符串
  if (!queryString || queryString.trim() === '') {
    return {};
  }

  const params: QueryParams = {};
  
  // 分割参数对
  const pairs = queryString.split('&');
  
  for (const pair of pairs) {
    if (!pair) continue;
    
    const [encodedKey, encodedValue] = pair.split('=');
    
    if (!encodedKey) continue;
    
    // 解码键和值
    const key = decodeURIComponent(encodedKey);
    const value = encodedValue === undefined ? '' : decodeURIComponent(encodedValue);
    
    // 处理重复参数（数组值）
    if (key in params) {
      const existingValue = params[key];
      if (Array.isArray(existingValue)) {
        existingValue.push(value);
      } else {
        params[key] = [existingValue, value];
      }
    } else {
      params[key] = value;
    }
  }
  
  return params;
}

/**
 * 将查询参数对象序列化为查询字符串
 * @param params - 查询参数对象
 * @returns 序列化后的查询字符串（不带问号）
 */
function serializeQueryParams(params: QueryParams): string {
  if (!params || typeof params !== 'object' || Object.keys(params).length === 0) {
    return '';
  }

  const pairs: string[] = [];

  for (const [key, value] of Object.entries(params)) {
    if (value === undefined || value === null) continue;
    
    const encodedKey = encodeURIComponent(key);
    
    if (Array.isArray(value)) {
      for (const item of value) {
        if (item === undefined || item === null) continue;
        const encodedValue = encodeURIComponent(String(item));
        pairs.push(`${encodedKey}=${encodedValue}`);
      }
    } else {
      const encodedValue = encodeURIComponent(String(value));
      pairs.push(`${encodedKey}=${encodedValue}`);
    }
  }

  return pairs.join('&');
}

/**
 * 获取 URL 的查询参数
 * @param url - URL 字符串
 * @returns 查询参数对象
 */
function getQueryParamsFromUrl(url: string): QueryParams {
  return parseQueryParams(url);
}

/**
 * 更新 URL 的查询参数
 * @param url - 原始 URL
 * @param updates - 要更新的参数
 * @returns 更新后的 URL
 */
function updateUrlQueryParams(url: string, updates: QueryParams): string {
  const urlParts = url.split('?');
  const baseUrl = urlParts[0];
  const existingParams = parseQueryParams(urlParts[1] || '');
  
  // 合并参数，updates 中的值会覆盖现有的值
  const mergedParams = { ...existingParams, ...updates };
  
  // 移除值为 undefined 或 null 的参数
  Object.keys(mergedParams).forEach(key => {
    if (mergedParams[key] === undefined || mergedParams[key] === null) {
      delete mergedParams[key];
    }
  });
  
  const queryString = serializeQueryParams(mergedParams);
  
  return queryString ? `${baseUrl}?${queryString}` : baseUrl;
}
```

### Reviewer 反馈

**APPROVED**

---

## 最终代码

```typescript
interface QueryParams {
  [key: string]: string | string[];
}

/**
 * 解析 URL 查询参数
 * @param urlOrQueryString - URL 字符串或查询参数字符串
 * @returns 解析后的查询参数对象
 */
function parseQueryParams(urlOrQueryString?: string): QueryParams {
  if (!urlOrQueryString || typeof urlOrQueryString !== 'string') {
    return {};
  }

  let queryString = urlOrQueryString;

  // 如果是完整的 URL，提取查询字符串部分
  const urlMatch = urlOrQueryString.match(/^(?:https?:\/\/[^?#]+)?\?([^#]*)/);
  if (urlMatch) {
    queryString = urlMatch[1];
  } else if (!urlOrQueryString.includes('=') && !urlOrQueryString.includes('&')) {
    // 如果看起来不像查询字符串，返回空对象
    return {};
  }

  // 处理空查询字符串
  if (!queryString || queryString.trim() === '') {
    return {};
  }

  const params: QueryParams = {};
  
  // 分割参数对
  const pairs = queryString.split('&');
  
  for (const pair of pairs) {
    if (!pair) continue;
    
    const [encodedKey, encodedValue] = pair.split('=');
    
    if (!encodedKey) continue;
    
    // 解码键和值
    const key = decodeURIComponent(encodedKey);
    const value = encodedValue === undefined ? '' : decodeURIComponent(encodedValue);
    
    // 处理重复参数（数组值）
    if (key in params) {
      const existingValue = params[key];
      if (Array.isArray(existingValue)) {
        existingValue.push(value);
      } else {
        params[key] = [existingValue, value];
      }
    } else {
      params[key] = value;
    }
  }
  
  return params;
}

/**
 * 将查询参数对象序列化为查询字符串
 * @param params - 查询参数对象
 * @returns 序列化后的查询字符串（不带问号）
 */
function serializeQueryParams(params: QueryParams): string {
  if (!params || typeof params !== 'object' || Object.keys(params).length === 0) {
    return '';
  }

  const pairs: string[] = [];

  for (const [key, value] of Object.entries(params)) {
    if (value === undefined || value === null) continue;
    
    const encodedKey = encodeURIComponent(key);
    
    if (Array.isArray(value)) {
      for (const item of value) {
        if (item === undefined || item === null) continue;
        const encodedValue = encodeURIComponent(String(item));
        pairs.push(`${encodedKey}=${encodedValue}`);
      }
    } else {
      const encodedValue = encodeURIComponent(String(value));
      pairs.push(`${encodedKey}=${encodedValue}`);
    }
  }

  return pairs.join('&');
}

/**
 * 获取 URL 的查询参数
 * @param url - URL 字符串
 * @returns 查询参数对象
 */
function getQueryParamsFromUrl(url: string): QueryParams {
  return parseQueryParams(url);
}

/**
 * 更新 URL 的查询参数
 * @param url - 原始 URL
 * @param updates - 要更新的参数
 * @returns 更新后的 URL
 */
function updateUrlQueryParams(url: string, updates: QueryParams): string {
  const urlParts = url.split('?');
  const baseUrl = urlParts[0];
  const existingParams = parseQueryParams(urlParts[1] || '');
  
  // 合并参数，updates 中的值会覆盖现有的值
  const mergedParams = { ...existingParams, ...updates };
  
  // 移除值为 undefined 或 null 的参数
  Object.keys(mergedParams).forEach(key => {
    if (mergedParams[key] === undefined || mergedParams[key] === null) {
      delete mergedParams[key];
    }
  });
  
  const queryString = serializeQueryParams(mergedParams);
  
  return queryString ? `${baseUrl}?${queryString}` : baseUrl;
}
```